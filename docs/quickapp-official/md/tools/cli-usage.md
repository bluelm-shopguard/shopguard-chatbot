# 快应用命令行开发指南

本节将介绍如何使用命令行（CLI）进行快应用的完整开发流程，从环境安装、项目创建、编译打包，到最终在真机上预览和发布。

> **注意** ：本节内容适用于偏好使用命令行的开发者。如果你使用快应用官方 IDE，则无需学习本节内容，IDE 已集成了相关功能。

通过本节，你将学会:

* 安装开发环境（Node.js、调试器）
* 安装 `hap-toolkit` 命令行工具
* 创建、编译和调试项目
* 理解 `rpk` 产出文件
* 在真机上预览效果
* 如何为正式发布打包和签名

---

## 1. 安装环境

### 安装 NodeJS

快应用开发依赖 NodeJS 环境。

* **要求** ：NodeJS 版本 ≥ 8.0 (推荐 10.0+)。
* **下载** ：请从 [NodeJS 官网](https://nodejs.org/) 下载并安装。

### 在手机上安装调试器

调试器是一个 Android 应用（`.apk`），用于在手机上安装、更新和调试快应用 `rpk` 文件。

* **下载** ：请前往[快应用官方文档的资源下载页](https://doc.quickapp.cn/tutorial/ide/resource.html)获取调试器 APK。
* **安装与使用** ：

1. 在手机上安装并打开调试器。
2. 核心功能按钮：
   * **扫码安装** ：通过扫描二维码，从电脑上的 HTTP 服务器下载并安装 rpk 包。
   * **本地安装** ：从手机存储中选择一个 `rpk` 文件进行安装。
   * **在线更新** ：重新拉取服务器上的 rpk 包，实现快速更新。
   * **开始调试** ：启动远程调试功能。

### （可选）在手机上安装平台预览版

为了体验最新的平台功能或在没有原生支持的手机上进行开发，可以安装平台预览版。

* **下载** ：同样在[资源下载页](https://doc.quickapp.cn/tutorial/ide/resource.html)获取平台预览版 APK。
* **切换平台** ：安装后，在调试器 App 中，可以点击“切换运行平台”并选择 `org.hapjs.mockup`，后续安装的 rpk 包就会在平台预览版中运行。

---

## 2. 安装 `hap-toolkit`

`hap-toolkit` 是快应用的官方命令行编译工具。

* **安装命令** ：通过 npm 全局安装。

```bash
  npm install -g hap-toolkit
```

* **验证安装** ：执行 `hap -v`，如果成功输出版本号，则表示安装成功。

```bash
  hap -v
```

---

## 3. 项目开发

### 创建项目

使用 `hap init` 命令可以快速创建一个标准的项目模板。

* **命令格式** ：`hap init <ProjectName>`

```bash
  hap init MyQuickApp
```

### 安装项目依赖

进入项目根目录，安装所需的 npm 模块。

```bash
cd MyQuickApp
npm install
```

### 编译项目

编译项目会将 `src` 目录下的源代码转换并打包成可在手机上运行的 `rpk` 文件。

* **手动编译** ：执行一次编译打包。

```bash
  npm run build
```

* **自动编译 (Watch 模式)** ：监听文件变化，保存后自动重新编译。

```bash
  npm run watch
```

编译成功后，项目根目录下会生成两个文件夹：

* `build/`: 存放编译后的临时文件。
* `dist/`: 存放最终产物，即 **快应用 `rpk` 文件** 。

---

## 4. 在真机上预览效果

将 `dist` 目录中生成的 `rpk` 文件安装到手机上。推荐使用 Wi-Fi 在线更新的方式，此方式要求手机和电脑在同一个局域网内。

1. **启动本地服务器**
   在项目根目录下执行 `server` 命令，它会启动一个本地 HTTP 服务器来提供 `rpk` 文件。

   ```bash
   # 使用默认端口 8000
   npm run server

   # 或者自定义端口
   npm run server -- --port 8080
   ```

   执行后，终端会显示一个二维码。
2. **手机扫码安装**

   * 打开手机上的 **快应用调试器** 。
   * 点击“ **扫码安装** ”。
   * 扫描终端上显示的二维码。
   * 配置成功后，点击“ **在线更新** ”，调试器会自动下载并安装 `rpk`，并唤起平台运行。

之后每次修改代码并（自动）编译后，只需在调试器中再次点击“在线更新”即可看到最新效果。

---

## 5. 调试项目

当应用运行起来后，可以使用远程调试功能进行断点、查看日志、审查元素等操作。详细内容请参考官方的[调试文档](https://doc.quickapp.cn/tutorial/debug/command-debugging.html)。

---

## 6. 发布前打包

当开发完成，准备正式发布时，需要对应用进行签名打包。

1. **生成签名文件**
   使用 `openssl` 工具生成签名所需的私钥 (`private.pem`) 和证书 (`certificate.pem`)。

   ```bash
   openssl req -newkey rsa:2048 -nodes -keyout private.pem -x509 -days 3650 -out certificate.pem
   ```

   根据提示输入国家、组织等信息即可。
2. **放置签名文件**
   将生成的 `private.pem` 和 `certificate.pem` 文件放入项目根目录下的 `sign/release/` 目录中。如果 `release` 目录不存在，请手动创建。

   > **注意** ：较新版本的 `hap-toolkit` 创建的项目，可能只需将签名文件直接放入 `sign/` 目录即可，请根据项目结构调整。
   >
3. **执行 release 打包**
   运行 `release` 命令，它会使用 `sign/release` 目录下的签名文件进行打包。

   ```bash
   npm run release
   ```

   执行成功后，会在 `dist/` 目录下生成一个带 `.release` 标志的 `rpk` 文件，如 `com.example.app.release.rpk`。这个文件就是可以提交到应用商店的正式包。

---

## 7. 离线预览正式包

如果你有一个打好的正式 `rpk` 包，想在手机上预览或发给他人测试，可以按以下步骤操作：

1. 确保手机上已安装 **平台预览版** 。
2. 将手机通过 USB 连接到电脑，并设置为“ **传输文件** ”模式。
3. 在手机的存储根目录下，创建一个名为 `rpks` 的文件夹。
4. 将你的 `.rpk` 文件复制到这个 `rpks` 文件夹中。
5. 打开手机上的**平台预览版**应用，即可在列表中看到并运行你放置的快应用。
